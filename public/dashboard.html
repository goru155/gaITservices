<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dashboard</title>

<style>
/* ‚ö†Ô∏è CSS UNCHANGED */
body{margin:0;font-family:Segoe UI, Arial;background:#F2F2F2;height:100vh;}
.header{height:60px;background:#003A8F;color:#FFFFFF;display:flex;align-items:center;justify-content:space-between;padding:0 20px;}
.app{display:flex;height:calc(100vh - 60px);}
.nav{width:260px;background:#FFFFFF;border-right:1px solid #ddd;display:flex;flex-direction:column;}
.nav-header{padding:18px;font-weight:600;color:#003A8F;border-bottom:1px solid #eee;}
.nav-item{padding:14px 18px;cursor:pointer;}
.nav-item.active,.nav-item:hover{background:#F5F9FF;color:#003A8F;}
.main{flex:1;overflow:hidden;}
.home{padding:30px;}
.services{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-top:25px;}
.service-card{background:#4F8F57;color:#fff;padding:18px;border-radius:6px;cursor:pointer;}
.case-box{background:#0E63B6;padding:25px;color:#fff;}
.case-box input,.case-box textarea{width:100%;margin:8px 0;padding:8px;}
.case-actions{margin-top:15px;}
.case-actions button{margin-right:10px;padding:8px 14px;border:none;cursor:pointer;}
.send{background:#4CAF50;color:#fff;}
.cancel{background:#E53935;color:#fff;}
.chat{display:none;height:100%;}
.chat-layout{display:flex;height:100%;}
.sidebar{width:320px;background:#fff;border-right:1px solid #ddd;overflow-y:auto;}
.contact{padding:14px;border-bottom:1px solid #eee;cursor:pointer;}
.contact:hover{background:#F5F9FF;}
.chat-box{flex:1;display:flex;flex-direction:column;background:#EFEAE2;}
.chat-header{padding:14px;background:#fff;border-bottom:1px solid #ddd;font-weight:600;color:#003A8F;}
.messages{flex:1;padding:15px;display:flex;flex-direction:column;overflow-y:auto;}
.msg{max-width:65%;padding:8px 12px;margin-bottom:8px;border-radius:8px;}
.msg.self{background:#DFF5E5;align-self:flex-end;}
.msg.other{background:#fff;align-self:flex-start;}
.input-box{display:flex;padding:10px;background:#fff;border-top:1px solid #ddd;}
.input-box textarea{flex:1;resize:none;padding:8px;}
.input-box button{margin-left:8px;background:#34C759;border:none;color:#fff;padding:8px 16px;border-radius:20px;}
.badge{background:red;color:#fff;border-radius:10px;padding:2px 6px;font-size:11px;margin-left:6px;}
</style>
</head>

<body>

<div class="header">
  <h3 id="welcome">Dashboard</h3>
  <button onclick="logout()">Logout</button>
</div>

<div class="app">

<div class="nav">
  <div class="nav-header" id="navName">User</div>
  <div class="nav-item active" onclick="showHome()">Home</div>
  <div class="nav-item" id="chatTab" onclick="showChat()">
    Chat <span class="badge" id="chatBadge" style="display:none">NEW</span>
  </div>
  <div class="nav-item" id="caseTab" style="display:none" onclick="showCases()">
    Case List <span class="badge" id="caseBadge" style="display:none">NEW</span>
  </div>
</div>

<div class="main">

<div class="home" id="home">

<div id="homeMain">
  <h2 style="text-align:center">A STOP FOR ALL YOUR CONSULTATION PROBLEMS</h2>
  <div class="services">
    <div class="service-card" onclick="openService1()">Service 1</div>
    <div class="service-card">Service 2</div>
    <div class="service-card">Service 3</div>
    <div class="service-card">Service 4</div>
  </div>
</div>

<div id="service1View" style="display:none">
  <button onclick="backToHome()">‚Üê Back</button>
  <h3>TOP PROFESSIONALS</h3>
  <div class="services" id="topProfessionals"></div>
</div>

<div id="caseFilingView" style="display:none">
  <button onclick="backToService1()">‚Üê Back</button>
  <h2>CASE FILING</h2>
  <div class="case-box">
    Client Name
    <input id="clientName">
    Contact No.
    <input id="contactNo">
    Description
    <textarea id="caseDesc" rows="5"></textarea>
    <div class="case-actions">
      <button class="send" onclick="submitCase()">Send Request</button>
      <button class="cancel" onclick="backToService1()">Cancel</button>
    </div>
  </div>
</div>

<div id="caseListView" style="display:none">
  <h2>Case Requests</h2>
  <div id="caseList"></div>
</div>

</div>

<div class="chat" id="chat">
  <div class="chat-layout">
    <div class="sidebar" id="contacts"></div>
    <div class="chat-box">
      <div class="chat-header" id="chatTitle">Select a chat</div>
      <div class="messages" id="messages"></div>
      <div class="input-box">
        <textarea id="msgText"></textarea>
        <button onclick="send()">Send</button>
      </div>
    </div>
  </div>
</div>

</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDp1KtG2mPWsCr1Wn7-nE7FM7bOaUxqn4w",
  authDomain:"auth-system-80428.firebaseapp.com",
  projectId:"auth-system-80428"
});

const auth=firebase.auth();
const db=firebase.firestore();

let myUid="", myName="", myRole="", currentChatId="", selectedWholesellerId="";

/* AUTH */
auth.onAuthStateChanged(async user=>{
  if(!user){location.href="index.html";return;}
  myUid=user.uid;

  const u=await db.collection("users").doc(myUid).get();
  if(u.exists){
    myRole="user";
    myName=u.data().name;
    navName.innerText=myName;
    welcome.innerText="Welcome "+myName;
    listenGlobalChatNotifications();
    return;
  }

  const w=await db.collection("wholesellers").doc(myUid).get();
  if(w.exists){
    myRole="wholeseller";
    myName=w.data().name;
    navName.innerText=myName;
    welcome.innerText="Welcome "+myName;
    caseTab.style.display="block";
    listenCaseNotifications();
    showCases();
  }
});

/* GLOBAL CHAT NOTIFICATION */
function listenGlobalChatNotifications(){
  db.collection("chats")
    .where("userId","==",myUid)
    .onSnapshot(s=>{
      let show=false;
      s.forEach(c=>{
        c.ref.collection("messages")
          .where("read","==",false)
          .get()
          .then(ms=>{
            ms.forEach(m=>{
              if(m.data().senderId!==myUid){
                show=true;
                chatBadge.style.display="inline-block";
              }
            });
          });
      });
      if(!show) chatBadge.style.display="none";
    });
}

/* NAV */
function resetViews(){
  homeMain.style.display="none";
  service1View.style.display="none";
  caseFilingView.style.display="none";
  caseListView.style.display="none";
}
function showHome(){resetViews();chat.style.display="none";home.style.display="block";if(myRole==="user")homeMain.style.display="block";}
function showChat(){home.style.display="none";chat.style.display="block";if(myRole==="user")loadWholesellers();if(myRole==="wholeseller")loadUserChats();}
function showCases(){resetViews();chat.style.display="none";home.style.display="block";caseListView.style.display="block";caseBadge.style.display="none";}

/* USER FLOW */
function openService1(){if(myRole!=="user")return;resetViews();service1View.style.display="block";loadProfessionals();}
function backToHome(){showHome();}
function backToService1(){caseFilingView.style.display="none";service1View.style.display="block";}
function loadProfessionals(){
  topProfessionals.innerHTML="";
  db.collection("wholesellers").get().then(s=>{
    s.forEach(d=>{
      topProfessionals.innerHTML+=`<div class="service-card" onclick="openCaseFilingView('${d.id}')">${d.data().name}</div>`;
    });
  });
}
function openCaseFilingView(wid){selectedWholesellerId=wid;service1View.style.display="none";caseFilingView.style.display="block";}
function submitCase(){
  if(!clientName.value||!contactNo.value||!caseDesc.value){alert("Fill all fields");return;}
  db.collection("wholesellers").doc(selectedWholesellerId).collection("cases").add({
    clientName:clientName.value,
    contactNo:contactNo.value,
    description:caseDesc.value,
    userId:myUid,
    userName:myName,
    status:"pending",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{alert("Request sent successfully");clientName.value="";contactNo.value="";caseDesc.value="";backToService1();});
}

/* CASE LIST */
function listenCaseNotifications(){
  db.collection("wholesellers").doc(myUid).collection("cases")
    .where("status","==","pending")
    .onSnapshot(s=>{
      caseList.innerHTML="";
      if(!s.empty) caseBadge.style.display="inline-block";
      s.forEach(d=>{
        const c=d.data();
        caseList.innerHTML+=`
          <div class="service-card">
            <b>${c.userName}</b><br>${c.contactNo}<br>${c.description}<br><br>
            <button onclick="acceptCase('${d.id}','${c.userId}','${c.userName}','${c.description}')">Accept</button>
            <button onclick="rejectCase('${d.id}','${c.userId}')">Reject</button>
          </div>`;
      });
    });
}

/* USER CHAT LIST */
function loadWholesellers() {
  contacts.innerHTML = "";

  db.collection("wholesellers").onSnapshot(s => {
    const wholesellers = [];
    s.forEach(d => wholesellers.push({ id: d.id, name: d.data().name }));

    // For each wholeseller, compute badge state, then render once
    const badgePromises = wholesellers.map(w => {
      const chatId = myUid + "__" + w.id;
      return db.collection("chats").doc(chatId).collection("messages")
        .where("read", "==", false)
        .get()
        .then(ms => {
          let showBadge = false;
          if (chatId !== currentChatId) {
            ms.forEach(m => {
              if (m.data().senderId !== myUid) showBadge = true;
            });
          }
          return { ...w, chatId, showBadge };
        });
    });

    Promise.all(badgePromises).then(results => {
      let html = "";
      results.forEach(w => {
        const badge = w.showBadge ? " <span class='badge'>NEW</span>" : "";
        html += `
          <div class="contact" onclick="openChat('${w.chatId}','${w.name}')">
            ${w.name}${badge}
          </div>`;
      });
      contacts.innerHTML = html;
    });
  });
}


function loadUserChats(){
  contacts.innerHTML="";
  db.collection("chats").where("wholesellerId","==",myUid).onSnapshot(s=>{
    contacts.innerHTML="";
    s.forEach(d=>{
      d.ref.collection("messages").orderBy("createdAt","desc").limit(1).get().then(ms=>{
        let badge="";
        ms.forEach(m=>{if(m.data().senderId!==myUid && !m.data().read) badge=" <span class='badge'>NEW</span>";});
        contacts.innerHTML+=`<div class="contact" onclick="openChat('${d.id}','${d.data().userName}')">${d.data().userName}${badge}</div>`;
      });
    });
  });
}

function openChat(id,name){currentChatId=id;chatTitle.innerText=name;listenMessages();}
function send(){
  if(!msgText.value||!currentChatId)return;
  if(myRole==="user"){
    db.collection("chats").doc(currentChatId).set({
      userId:myUid,
      userName:myName,
      wholesellerId:currentChatId.split("__")[1]
    },{merge:true});
  }
  db.collection("chats").doc(currentChatId).collection("messages").add({
    senderId:myUid,
    senderName:myName,
    text:msgText.value,
    read:false,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  msgText.value="";
}

function listenMessages(){
  db.collection("chats")
    .doc(currentChatId)
    .collection("messages")
    .orderBy("createdAt")
    .onSnapshot(s=>{
      messages.innerHTML="";
      let unread=false;

      s.forEach(d=>{
        const m=d.data();

        if(m.senderId!==myUid && !m.read){
          d.ref.update({read:true});
        }
        if(m.senderId!==myUid && !m.read) unread=true;

        // üïí TIMESTAMP (send + receive + system)
        let timeText="";
        if(m.createdAt){
          const dt = m.createdAt.toDate();
          timeText = dt.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit"
          });
        }

        messages.innerHTML += `
          <div class="msg ${m.senderId===myUid?'self':'other'}">
            <div>${m.text}</div>
            <div style="font-size:11px;color:#666;text-align:right;margin-top:4px;">
              ${timeText}
            </div>
          </div>
        `;
      });

      if(!unread) chatBadge.style.display="none";
      messages.scrollTop=messages.scrollHeight;
    });
}


/* ACCEPT / REJECT */
function acceptCase(caseId,userId,userName,desc){
  db.collection("wholesellers").doc(myUid).collection("cases").doc(caseId).update({status:"accepted"});
  const chatId=userId+"__"+myUid;
  db.collection("chats").doc(chatId).set({userId,userName,wholesellerId:myUid},{merge:true});
  db.collection("chats").doc(chatId).collection("messages").add({
    senderId:myUid,text:"üü¢ Case Accepted:\n"+desc,read:false,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
}
function rejectCase(caseId,userId){
  db.collection("wholesellers").doc(myUid).collection("cases").doc(caseId).update({status:"rejected"});
  const chatId=userId+"__"+myUid;
  db.collection("chats").doc(chatId).set({userId,wholesellerId:myUid},{merge:true});
  db.collection("chats").doc(chatId).collection("messages").add({
    senderId:myUid,text:"üî¥ Case Rejected. Please try later.",read:false,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
}

function logout(){auth.signOut().then(()=>location.href="index.html");}
</script>

</body>
</html>

